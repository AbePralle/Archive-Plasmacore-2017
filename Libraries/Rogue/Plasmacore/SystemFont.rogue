module Plasmacore

routine SystemFont->Font
  if (not Display.system_font) Display.system_font = Font( "SystemFont", &options=@{snug,snap} )
  return Display.system_font
endRoutine

class SystemFontData : FontData
  METHODS
    method init
      name = "SystemFont"
      exists = true

      forEach (i in 0..<95)
        local unicode = Character( ' ' + i )
        local ch = FontCharacter( unicode, XY(9,17) )
        if (unicode < 128) characters[ unicode ] = ch
        else               characters.add( ch )
        character_lookup[ unicode ] = ch
      endForEach

    method load
      if (is_loaded) return
      is_loaded = true

      local bitmap = Bitmap( png_data )
      local sheet_builder = ImageSheetBuilder( 512, 8 )

      local w = bitmap.width / 95
      local h = bitmap.height
      height = h

      local char_bounds = Box[]( 95 )
      forEach (i in 0..<95)
        char_bounds.add( sheet_builder.place(Bitmap(bitmap,Box(i*w,0,w,h))) )
      endForEach

      local font_sheet = Image( sheet_builder->Texture )
      font_sheet.anchor = Anchor.TOP_LEFT

      forEach (i in 0..<95)
        local ch = character_lookup[ Character( ' ' + i ) ]
        ch.image = Image( font_sheet, char_bounds[i] )
      endForEach

  GLOBAL PROPERTIES
    png_data = Byte[](
      "89504E470D0A1A0A0000000D49484452000003570000001102030000004C45BE8F0000" ...
      "0009504C5445FFFFFF000000FFFFFF7EEF8F4F0000000174524E530040E6D866000004" ...
      "AB49444154785EDD96D1CAEB2810C7F542DF2081F569EC457B6D215358AF7717264F93" ...
      "0FD25EF45A0BF129F73FDAA45F430FCB8185B3ACA5C4E838E637338EA3B6668219D4AF" ...
      "6D847F17FE5D9D76EAF3AFA5D2EC9572D387894175FEA7B50D86020DFDEC5813D6E33D" ...
      "ECE71569F2143ADFE171A0A1C3D8666188638A202732D23DCA830832E64C03941EE93C" ...
      "6004124D863AAA4344ABB0C254C1BEFD2C0A57DF5190A74ECA1D0679D9B53DAC09F2D3" ...
      "C320FD6C6F13A7981D1F17EFBC49767EC34AFD726053CEE3ECBC2B7E3C1408F78B6F16" ...
      "869F673DCE7139662B32902AA7F235CECC7651F62B2756EE74FBCA98C2AA5395595CC4" ...
      "50626674CA344EACEC82CF005282C2EA3186F6113D6E5849E165D7DC0EAB9FEC646793" ...
      "FF405FF47D7166EE1FA73BB0309E3485CD1226B9482293932347073E5092CFF1E4BB60" ...
      "B2D845E7C4F1B29C4486B3A3D3F58C0E9BBC625D6ED79CEBAA2A73B97EC33A5E260EEC" ...
      "0D1B0A2D36EC552203EF3AC3C38CD8D074C8C36512D7FAE6F5A33CE2CEEB2ED8095E29" ...
      "69C52A0B938915AB9F74D68F69B3849DDD189F580C67668057ACD1BBA99F3B0115AC18" ...
      "1B1664EC24A0AC13B01E33B0EEB7FC0D6BB053EB70FCD3456CC82A7AC5EB7ECDA37141" ...
      "90243DA631BBA40BB6C0AA72C19478BD6039A696A667F57ADD39D9CB5CB10C9D39C7A0" ...
      "25083BEFD03123450468475E3CEB466273F922C1225B423F8D2B560CAEF878BECC3C36" ...
      "AC8145E60AE3AE5813B0FEBA2D2F2CF64FAC07F733B0628044D8B0CC669E78CCD5EB5D" ...
      "D2B16241CF3A75BA63AF484DCFEAF5580D6A8E41D464B071EA1193F63AD480655BB278" ...
      "D21560B90004560098233B44DAE442CCCF20640F7480077E00AB9C9362C8D802AC71A9" ...
      "582554AC7BCE6277C88418BE61C9B9F50CDBEDB086E6800A51CFD6637EC7027170FE89" ...
      "55BF279E59B0D83F5302FE9C4DEEAFA77BAA586FDE8ADEDD3DEB76A428020B944B5FEA" ...
      "EAE62DE80756F9EEAD47FD1C7359BD7503160F62E5D0CF1BD6EFD9E007223B6F5835C0" ...
      "AA790ABCB56195F08E25790A582FAFCB59906C139F5803FE652176E3E53637AC7AB6EA" ...
      "F54C9E2B56CD0B63F182C59ED970F5563B5B085D1E3F9D2D8B3DE757CA509586D2138B" ...
      "B3C8542293362CF70A669CAD1F7A6B5294DEBC75CCFA83B7987F7BDC2A56D05C33A1C5" ...
      "841A0FF2319EAD24376262C15235CBC9D96A9910A6608AF195091B96C9B68E90C3CC0B" ...
      "2B57AC6309DCD0AF8195CE3BAC2458BA6175D9BB83E4CF372C0D2C123D67CE75E41ADA" ...
      "D9521B96927BAB7B5C17F4FB75E6899555BF004BAE22C52E1B392C31DB54B1DABD05AC" ...
      "5880B5DD5B931E81651753608C7179DE5B0C4DE88DB07B3B520DAB4CC0E26F41B86542" ...
      "9DAA1E578055F55C80D53221B00A0E665F9E7AFA65CB846A0B422555861ECF84BE9D4D" ...
      "9BA90F048232A4C850A0A048AE104FAA1B10A1922B9E5586941F44C7ADCA80E44058A3" ...
      "E9209DB5CA50866B4D6182A8AC32B5C601D10BCB343D9D2CC72609CBC9BB558F2CE7C1" ...
      "C463D0145AD1D2F662B3DE5BBB9A509197CE5665E0D1A87FD8DC4FD7A5D17F1AE5A0C8" ...
      "004B13ED6634A58AFAB60E926EAFA7CB5B95B1ABA75E35605847FEA17D2E407F7E8594" ...
      "4576A9996B8F55E67645FF13969B2B839DC0F15F691424F63E7B2BB4C07C13FF609E6E" ...
      "73C5FFB8FD0DE662E021BABB6DAE0000000049454E44AE4260820A"
    )

endClass

